// Generated by CoffeeScript 1.9.1
(function() {
  var overviewController;

  overviewController = angular.module('adminHelper.ACS.controllers');


  /*
    Controller UsersOverview
  
    Angular controller for main view to ACS overview part.
   */

  overviewController.controller('ACSOverviewController', [
    '$scope', '$state', 'Restangular', 'ACSModalFactory', 'sessionFactory', function($scope, $state, Restangular, ACSModalFactory, sessionFactory) {
      var orderBase, requestBase, ruleBase, zoneBase;
      console.log('loaded');
      sessionFactory.get_logged_user().then(function(resp) {
        return sessionFactory.get_user_data(resp.id);
      }, function() {
        return $state.go('login');
      });
      zoneBase = Restangular.all('api/ACSZones');
      orderBase = Restangular.all('api/ACSOrders');
      requestBase = Restangular.all('api/ACSRequests');
      ruleBase = Restangular.all('api/ACSRules');
      $scope.updateZoneData = function() {
        return $scope.zones = zoneBase.getList().$object;
      };
      $scope.updateOrderData = function() {
        $scope.orders = null;
        return $scope.orders = orderBase.customGETLIST('', {
          'nonExecutedOnly': ''
        }).$object;
      };
      $scope.updateRequestData = function() {
        return $scope.requests = requestBase.getList().$object;
      };
      $scope.openACSZoneAddModal = function() {
        var instance;
        instance = ACSModalFactory.openACSZoneAddModal();
        return instance.result.then(function() {
          return $scope.updateZoneData();
        });
      };
      $scope.openACSOrderAddModal = function() {
        var instance;
        instance = ACSModalFactory.openACSOrderAddModal();
        return instance.result.then(function() {
          return $scope.updateOrderData();
        });
      };
      $scope.openACSRequestAddModal = function() {
        var instance;
        instance = ACSModalFactory.openACSRequestAddModal();
        return instance.result.then(function() {
          return $scope.updateRequestData();
        });
      };
      $scope.acceptRequest = function(requestID) {
        return requestBase.get(requestID).then(function(request) {
          var req;
          req = orderBase.post({
            rule: request.rule,
            user: sessionFactory.user.id,
            grant_privilege: request.grant_privilege
          });
          request.remove();
          return req.then(function() {
            $scope.updateOrderData();
            return $scope.updateRequestData();
          });
        });
      };
      $scope.deleteRequest = function(requestID) {
        return requestBase.get(requestID).then(function(reqRequest) {
          return ruleBase.get(reqRequest.rule).then(function(ruleRequest) {
            ruleRequest.remove();
            reqRequest.remove();
            return $scope.updateRequestData();
          });
        });
      };
      $scope.deleteOrder = function(orderID) {
        return orderBase.get(orderID).then(function(orderRequest) {
          return ruleBase.get(orderRequest.rule).then(function(ruleRequest) {
            ruleRequest.remove();
            orderRequest.remove();
            return $scope.updateOrderData();
          });
        });
      };
      $scope.executeOrder = function(orderID) {
        return orderBase.get(orderID).then(function(orderRequest) {
          return orderRequest.one('execute').post().then(function(resp) {
            return $scope.updateOrderData();
          });
        });
      };
      $scope.updateZoneData();
      $scope.updateOrderData();
      return $scope.updateRequestData();
    }
  ]);

}).call(this);

//# sourceMappingURL=ACSOverview.controller.js.map
