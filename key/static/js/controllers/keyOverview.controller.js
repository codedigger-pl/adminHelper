// Generated by CoffeeScript 1.9.1
(function() {
  var overviewController;

  overviewController = angular.module('adminHelper.key.controllers');


  /*
    Controller UsersOverview
  
    Angular controller for main view to Key overview part.
   */

  overviewController.controller('KeyOverviewController', [
    '$scope', '$state', 'Restangular', 'KeyModalFactory', 'sessionFactory', function($scope, $state, Restangular, KeyModalFactory, sessionFactory) {
      var orderBase, requestBase, ruleBase, zoneBase;
      sessionFactory.get_logged_user().then(function(resp) {
        return sessionFactory.get_user_data(resp.id);
      }, function() {
        return $state.go('login');
      });
      zoneBase = Restangular.all('api/keys');
      orderBase = Restangular.all('api/keyOrders');
      requestBase = Restangular.all('api/keyRequests');
      ruleBase = Restangular.all('api/keyRules');
      $scope.updateKeyData = function() {
        return $scope.keys = zoneBase.getList().$object;
      };
      $scope.updateOrderData = function() {
        $scope.orders = null;
        return $scope.orders = orderBase.customGETLIST('', {
          'nonExecutedOnly': ''
        }).$object;
      };
      $scope.updateRequestData = function() {
        return $scope.requests = requestBase.getList().$object;
      };
      $scope.openKeyAddModal = function() {
        var instance;
        instance = KeyModalFactory.openKeyAddModal();
        return instance.result.then(function() {
          return $scope.updateKeyData();
        });
      };
      $scope.openKeyOrderAddModal = function() {
        var instance;
        instance = KeyModalFactory.openKeyOrderAddModal();
        return instance.result.then(function() {
          return $scope.updateOrderData();
        });
      };
      $scope.openKeyRequestAddModal = function() {
        var instance;
        instance = KeyModalFactory.openKeyRequestAddModal();
        return instance.result.then(function() {
          return $scope.updateRequestData();
        });
      };
      $scope.acceptRequest = function(requestID) {
        return requestBase.get(requestID).then(function(request) {
          var req;
          req = orderBase.post({
            rule: request.rule,
            user: sessionFactory.user.id,
            grant_privilege: request.grant_privilege
          });
          request.remove();
          return req.then(function() {
            $scope.updateOrderData();
            return $scope.updateRequestData();
          });
        });
      };
      $scope.deleteRequest = function(requestID) {
        return requestBase.get(requestID).then(function(reqRequest) {
          return ruleBase.get(reqRequest.rule).then(function(ruleRequest) {
            ruleRequest.remove();
            reqRequest.remove();
            return $scope.updateRequestData();
          });
        });
      };
      $scope.deleteOrder = function(orderID) {
        return orderBase.get(orderID).then(function(orderRequest) {
          return ruleBase.get(orderRequest.rule).then(function(ruleRequest) {
            ruleRequest.remove();
            orderRequest.remove();
            return $scope.updateOrderData();
          });
        });
      };
      $scope.executeOrder = function(orderID) {
        return orderBase.get(orderID).then(function(orderRequest) {
          return orderRequest.one('execute').post().then(function(resp) {
            return $scope.updateOrderData();
          });
        });
      };
      $scope.updateKeyData();
      $scope.updateOrderData();
      return $scope.updateRequestData();
    }
  ]);

}).call(this);

//# sourceMappingURL=keyOverview.controller.js.map
